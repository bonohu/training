## 応用例1:予測遺伝子セットの機能アノテーション

実は、BLASTコマンドは複数のqueryのあるマルチFASTA形式にも対応していて、queryに含まれるエントリ全てに対して順にBLAST検索してくれるようになっている。
これを利用して、まだ機能アノテーションが付けられていない遺伝子セットをqueryとし、UniProtやヒトのタンパク質配列セットをDBとしてBLAST検索することで各配列の持つ機能を推定することができる。

本節で紹介したBLASTを利用して、研究対象にしている遺伝子配列が取得してきた配列セットのなかにあるか、ある場合はどれぐらい似ていたか、などを調べることができる。
ここでは、ゲノム配列が決定され、予測遺伝子セットも公開されているニホンミツバチ(*Apis cerana japonica*)を例に説明する。
https://www.ddbj.nig.ac.jp/news/ja/wn170710.html
queryとして公開されている予測遺伝子セット（塩基(cDNA)配列セットとタンパク質配列セット）、DBとしてヒトタンパク質配列セットを用いる。

まず、queryを取得する。
3-1節でダウンロードしたファイルのうち、アミノ酸配列セットである`Supplemental_data_3_aa.fa.gz`を用いる。

```
# BLAST検索するために圧縮を展開しておく
% pigz -d Supplemental_data_3_aa.fa.gz
# できたファイルをlsで確認
% ls
Supplemental_data_3_aa.fa
# 配列がいくつあるか、数える
% grep -c ^\> Supplemental_data_3_aa.fa
13222
```

`grep`の引数`^\>`の`^`は先頭にマッチ、`\>`は'>'という文字という意味である。
'>'はUNIXコマンドラインにおいて特別な意味（リダイレクト）があるため、バックスラッシュ(`\`)をつけてその特別な意味を削ぎ落として単なる文字の'>'としてパターンマッチするという意味になる。
そのため、バックスラッシュをつけることは必須である。
なお、このバックスラッシュを忘れてしまった場合、`grep`の結果をリダイレクトするという意味になるため、`Supplemental_data_3_aa.fa`という名前でファイルへ書き込むことになり、せっかく**ダウンロードしたファイルを破壊してしまうこととなる**ので十分に注意が必要である。
また、オプション`-c`はパターンマッチのあった行数をカウントだけするというオプションである。

FASTA形式では配列データが複数行に渡っていても、ヘッダ行は必ず1行である。
またヘッダ行は`>`から始まり複数行にわたることはないため、その行を数えることで配列がいくつあるかがわかる。
その結果、この例では、該当する行が13,222あったため、すなわち遺伝子数としても13,222となる。

BLAST検索するためにはDBはインデックスする必要がある。
そこで、BLAST検索の対象DBとするために、ヒトタンパク質配列セットをBLAST検索用に`makeblastdb`する。
3-1節で取得してきたEnsemblのタンパク質セットに含まれるヒト(*Homo sapiens*)のタンパク質配列(`Homo_sapiens.GRCh38.pep.all.fa.gz`)を利用する。
以下のコマンド例では、このファイルが`ensembl_pep-fa`ディレクトリ以下に置かれているものとしていることに注意。

```
# FASTA形式ファイルはgzip圧縮されているのでそれを展開
% pigz -d ensembl_pep-fa/Homo_sapiens.GRCh38.pep.all.fa.gz
# BLAST用のindex作成（タンパク質配列用）
% makeblastdb -in ensembl_pep-fa/Homo_sapiens.GRCh38.pep.all.fa -dbtype prot -hash_index -parse_seqids
```

準備ができたらいよいよBLAST検索だ。
オプションで`-max_target_seqs 1`とすることで、一つのヒットだけを表示するように制限している。
これまでの`-outfmt 7`と若干異なるまた`-outfmt 6`とすることで、結果にヘッダ行が各検索ごとに出るのを抑制している。

```
# ニホンミツバチ vs ヒトのタンパク質配列総当たり戦。時間がかかる
% blastp -query Supplemental_data_3_aa.fa -db ensembl_pep-fa/Homo_sapiens.GRCh38.pep.all.fa -evalue 1e-10 -num_threads 4 -outfmt 6 -max_target_seqs 1 | pigz -c > acj_vs_hs.txt.gz
# 得た結果を圧縮をほどきながらみる
% pigz -dc acj_vs_hs.txt.gz | less
g1.t1   ENSP00000497018.1       32.372  312     182     7       84      395     449     731     1.10e-41        157
g1.t1   ENSP00000497018.1       32.154  311     182     6       88      398     369     650     9.94e-37        143
g1.t1   ENSP00000497018.1       30.114  352     191     9       88      398     341     678     1.45e-34        137
g1.t1   ENSP00000497018.1       29.904  311     189     8       88      398     425     706     9.04e-34        135
g1.t1   ENSP00000497018.1       34.706  170     110     1       229     398     314     482     1.10e-24        108
g1.t1   ENSP00000497018.1       33.714  175     115     1       224     398     253     426     3.25e-24        106
g2.t1   ENSP00000300619.6       27.863  847     480     22      668     1507    444     1166    8.65e-66        246
g2.t1   ENSP00000300619.6       25.626  999     564     28      230     1157    262     1152    3.82e-59        225
g2.t1   ENSP00000300619.6       26.478  846     501     25      714     1501    211     993     1.55e-56        217
g2.t1   ENSP00000300619.6       27.560  791     454     22      728     1501    193     881     2.30e-52        203
g2.t1   ENSP00000300619.6       29.111  450     277     12      49      486     238     657     2.67e-35        148
g2.t1   ENSP00000300619.6       28.425  489     313     15      49      513     714     1189    6.40e-34        144
g2.t1   ENSP00000300619.6       27.789  511     296     16      32      486     528     1021    1.64e-30        133
g2.t1   ENSP00000300619.6       34.646  254     159     5       236     486     212     461     2.08e-27        122
g2.t1   ENSP00000300619.6       34.231  260     160     6       232     486     236     489     4.54e-27        121
g2.t1   ENSP00000300619.6       33.921  227     143     5       263     486     211     433     7.67e-23        108
g2.t1   ENSP00000300619.6       30.417  240     127     4       1295    1501    145     377     4.29e-22        105
g2.t1   ENSP00000300619.6       35.169  236     146     5       251     483     171     402     7.47e-21        101
g2.t1   ENSP00000300619.6       38.889  144     82      3       346     486     209     349     1.25e-17        90.9
（以下略）
```

1つだけのヒットとしたにも拘らず、1つのタンパク質配列に対して複数行結果が出ているように見えるだろう。
これは、ヒットした相手の配列は1つであるが、ローカルアラインメントのため複数の場所にヒットがあり、それが全て出力されているからそう見えるのである。
ここは以下のように処理して、対応関係だけを抽出するとよいだろう。

```
# 展開して、第1,2カラムを抜き出して、ソート＆重複のぞく
% pigz -dc acj_vs_hs.txt.gz | cut -f1,2  | sort -u > acj_vs_hs-uniq.txt
% less acj_vs_hs-uniq.txt
g1.t1   ENSP00000497018.1
g10.t1  ENSP00000423820.1
g1000.t1        ENSP00000448012.1
g10000.t1       ENSP00000375053.4
g10001.t1       ENSP00000387814.1
g10002.t1       ENSP00000217109.4
g10008.t1       ENSP00000368977.1
g10009.t1       ENSP00000449370.1
（以下略）
```

そして、この第1カラム（ニホンミツバチのID）だけを抽出、上記の操作で重複はないはずなのだが、念の為ソート＆重複を除く操作をして、行数を数えると、ヒト遺伝子にヒットのあったニホンミツバチの遺伝子数を数えることができる。

```
# 対応表の第1カラムだけ抽出してその数を数える
% cut -f 1 acj_vs_hs.txt | sort -u | wc -l
   7952
```

ニホンミツバチで予測された遺伝子数が13,222だったので、ヒト遺伝子にヒットのあった遺伝子の割合は、
`7952/13222 = 0.60142187`
となる。
つまり、約6割のニホンミツバチ遺伝子は、ヒト遺伝子と配列相同性があるということがわかる。
